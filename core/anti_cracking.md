---
layout: default
title: 吉里吉里Z固有的破解对策
---

<!-- 吉里吉里2/Zは、その拡張性の高さからクラッキングしようとした時にその糸口となる箇所が複数存在する。  
ここでは吉里吉里固有の対策について記述する。 -->
吉里吉里2/Z由于其扩张性之高，在试图破解时存在多处入手点。
在此记述吉里吉里固有的对策。

## 可执行文件替换对策
<!-- 認証を行う場合、何もチェックがない実行ファイルと差し替えて実行出来てしまうと、何も対策していないに等しい。  
入手可能な実行ファイルと差し替えて動かないようする必要がある。  
パッチや体験版配布などで公開された実行ファイルへの差し替えでの動作も注意する。  
対象のゲームデータ、DLL等が特定の実行ファイルでないと動かないようにする。  
暗号化されたxp3の復号化処理を組み込んでしまえば他の実行ファイルでは起動できなくなる。  
ただ復号化されたアーカイブを作られれば意味がなくなるので、他に固有の機能を追加するなどもした方が良い。  
過去のクラッキングされた実行ファイルが使えないようにするため継続的な開発が必要になる。 -->

如果进行校验时，如果可以用不执行任何校验的可执行文件替换并执行，那么就等于没有采取任何措施。
需要确保替换可执行文件后无法正常运行。
补丁和体验版发布等公开的可执行文件的替换行为也要注意。
目标游戏数据、DLL等应该只能在特定的可执行文件中运行。
如果将加密的xp3的处理程序集成到可执行文件中，则其他可执行文件将无法启动。
但是，如果生成了解密的归档文件，则意义将消失，因此最好添加其他独特的功能。
为了使过去被破解的可执行文件无法继续使用，需要持续开发。


## 禁止自动加载插件
<!-- tpmの拡張子を持つdllを自動的に読み込む機能があるが、自動読み込みされると組み込みAPI置き換えなど出来てしまうので、出来ないようにする必要がある。  
ただし、この対策を行うと組み込み機能のプラグインを使った暗号化が使えなくなる。 -->
虽然具有自动读入带有tpm扩展名的dll的功能，但如果被自动读入的话，就会出现嵌入式API置换等，所以有必要禁止。
但是，如果采取这种措施，则无法使用嵌入式功能插件进行加密。

## 禁止自动加载脚本
<!-- data.xp3内のstartup.tjs等初期にロードされるスクリプトが固定されているので、それを差し替えられると組み込みAPI置き換えなど出来てしまうので、出来ないようにする必要がある。  
初期に読み込むスクリプトの場所を1つに固定したり、スクリプトの改竄検出を行ったり、xp3の暗号化を行い読み込み時毎回復号化することで、特定のスクリプト以外の差込をある程度回避できる。  
TVP\_START\_UP\_SCRIPT\_NAME に任意の文字列を設定してコンパイルすることで任意のスクリプトを初期実行し、-startupオプションでの任意スクリプト実行を抑止する。  
TVPSystemSecurityOptions でdata.xp3からの読み込みを強制するなどの指定も可能。 -->
因为data.xp 3内的startup.tjs等初期被加载的脚本是固定的，如果这些被替换的话，嵌入API替换等就会发生，所以有必要禁止。
将初期读入脚本的场所固定为1处，进行脚本的窜改检测，加密xp3，读入时每次都进行解密，在某种程度上可以回避特定脚本以外的替换。
通过将TVP\_START\_UP\_SCRIPT\_NAME设置为任意字符串并进行编译，实现初期执行任意脚本，或禁用-startup选项执行任意脚本。
还可以指定TVPSystemSecurityOptions强制从data.xp3读取。


## 插件替换对策
<!-- 元のプラグインをリネームし同名のプラグインを置くことで任意のプラグインの読み込みが出来る、そのプラグインが公開しているAPIを乗っ取ったり、組み込みAPIの置き換えが可能になる。  
krmovie.dll等ファイル読み込みを行うdllを置き換えると、そのdllに渡されるデータを簡単に取得できる(1.3以降ではkrmovie.dllは本体に組み込まれるので、krmovie.dllに関してはこの問題はなくなる)。  
krmovie.dllの場合は動画ファイル、KAGParser.dll系ではKAGスクリプト。  
これを回避するためにdllの改竄検出をする必要がある。  
読み込むdllのハッシュを見たり、電子署名のチェックを行ったり。  
ただ、チェックに時間がかかると実行に影響が出るので高速なチェックが出来るものである必要がある。  
プラグインを本体に組み込んでしまい、プラグイン自体使えないようにすればその辺り気にしなくてよい。  
[Extension](http://www.kaede-software.com/2014/01/extension.html) 機能によって機能追加可能になっているが、プラグインのソースコード変更なしに行うことは現在できない。  
ソースコードの変更なしにビルド方法の変更によってスタティックライブラリを作り、それを本体とリンクすることで本体に組み込み可能にすることが目標。 -->
通过重命名原来的插件并放置同名的插件，可以读取任意的插件，可以劫持该插件公开的API，或者替换嵌入式API。
如果替换krmovie.dll等进行文件读入的dll的话，可以简单地取得被传递到那个dll的数据（1.3以后krmovie.dll被编入主体，关于krmovie.dll这个问题就消失了）。
krmovie.dll则可截取动画文件，KAGParser.dll则可截取KAG脚本。
为了避免这种情况，有必要检测dll的篡改。
查看读入dll的散列，检查电子签名。
但是，如果检查耗时长的话，会对运行产生影响，因此需要能够进行高速的检查。
如果将插件编入本体，使插件本身无法使用的话，就不用担心这一点了。
[Extension](http://www.kaede-software.com/2014/01/extension.html)功能提供了附加功能，但在没有更改插件源代码的情况下，目前无法执行此操作。
目标是在不更改源代码的情况下，通过更改构建方法创建静态库，并将其与主体链接，使其能够嵌入到主体中。

## 使用热键禁用控制器、脚本编辑器、监控和控制台
<!-- 吉里吉里Zでは「コントローラ、スクリプトエディタ、監視式」は削除され、コンソールはコマンドラインとなっている。  
[削除された機能](../TJS2/deleted.html)  
これらの機能を無効化する。  
吉里吉里Zでは、プラグインでコンソール出力を得られるので、それも抑止する。  
コンソール出力自体を無効化すると、少し高速化すると思われる。
TVP\_LOG\_TO\_COMMANDLINE\_CONSOLE を付けずにビルドするとコマンドラインにはログが出力されなくなる(公開バイナリはONで出力される)。  
コンソール出力を無効化するのなら、OSSライセンスをログに出力するタイプのプラグインもあるので、そのようなプラグインを使用する場合は、licenseが記述されたテキストを別途添付する必要があるので注意が必要。 -->
吉里吉里Z中“控制器、脚本编辑器、表达式监视器”被删除，控制台成为命令行。
[已删除的功能](../TJS2/deleted.html)
这些功能的禁用。
在吉里吉里Z中，由于通过插件可以得到控制台输出，所以也可以抑制它。
如果将控制台输出本身禁用，估计会稍微加快速度。
如果在不使用TVP\_LOG\_TO\_COMMANDLINE\_CONSOLE的情况下进行构建，则命令行不显示日志（公开二进制文件显示为ON）。
如果要禁用控制台输出，请注意，某些类型的插件会将OSS许可证输出到日志中，因此在使用此类插件时，必须附加单独的描述许可证的文本。

## 字节编码化
<!-- TJS2スクリプトがそのままの状態で格納されていると解析が容易なので、スクリプトをバイトコード化する。  
バイトコード化はScripts.compileStorageによって可能。  
アーカイブが暗号化されていても、そこを突破されることはあるので、スクリプトの解析を困難にしておく意味はある。  
また、バイトコードの方がスクリプトよりも高速に読み込める(スクリプトのコンパイルが事前に行われているので)。 -->
TJS2脚本以原样的状态被收纳的话，容易解析，因此将脚本字节编码化。
字节编码可通过Scripts.compileStorage实现。
即使归档文件被加密了，也有被破解的时候，但使脚本的解析变得困难的意义是有的。
字节码的读取速度也比脚本快（因为脚本是预先编译的）。

## 字节码混淆处理
<!-- バイトコードの解析を困難にするため難読化する。  
難読化は主に可読可能な文字列を置き換えることで処理の類推を困難にする。  
組み込みの関数の難読化も同時にできるとより強力である。  
現在TJS2バイトコードの難読化ツール等は提供されていない。 -->
为了使字节码的解析变得困难，进行混淆。
难读化主要是通过置换可读字符串，使处理的类推变得困难。
如果同时进行编入函数的难读化，则会更加强大。
现在还没有提供TJS2字节码的混淆工具等。

## 归档加密
<!-- xp3アーカイブはリリーサーに暗号化dllを渡すことで暗号化することが出来る。  
復号化はtpmプラグインを読み込ませることで行う。   -->
xp3归档可以通过将加密dll传递给Releaser来加密。
解密通过读取tpm插件来进行。